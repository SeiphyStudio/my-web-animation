<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©ç†èª²å ‚è¡Œç‚ºè§€æ¸¬è¨˜éŒ„ç³»çµ±</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --panel-bg: #ffffff;
            --border-color: #dcdcdc;
            --primary-color: #1a73e8; /* ç‰©ç†è— */
            --text-color: #333;
            /* è¡Œç‚ºé¡è‰²å®šç¾© */
            --c-serious: #28a745; /* èªçœŸ - ç¶ å…‰ */
            --c-answer: #007bff; /* æ¶ç­” - è—å…‰ */
            --c-sleep: #6f42c1; /* ç¡è¦º - ç´«å…‰ */
            --c-chat: #fd7e14; /* èŠå¤© - æ©˜å…‰ */
            --c-phone: #dc3545; /* æ»‘æ‰‹æ©Ÿ - ç´…å…‰ */
            --c-distract: #6c757d; /* åˆ†å¿ƒ - ç°å…‰ */
            --c-change: #17a2b8;  /* æ›åº§ä½ - é’è‰² */
            --c-custom: #d63384; /* è‡ªè¨‚ - æ¡ƒç´… */
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* é ‚éƒ¨æ§åˆ¶åˆ— */
        header {
            background-color: var(--panel-bg);
            padding: 0.8rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            flex-wrap: wrap;
        }

        .title-group {
            display: flex;
            align-items: baseline;
            gap: 20px;
        }

        /* ä¿®æ”¹æ¨™é¡Œæ¨£å¼ */
        .main-title {
            margin: 0;
            font-size: 2.5rem; /* å­—é«”æ”¾å¤§ */
            color: var(--primary-color);
            font-weight: 900;
            letter-spacing: 1px;
        }

        .mode-switch-group {
            display: flex;
            background: #e9ecef;
            padding: 4px;
            border-radius: 8px;
            gap: 5px;
        }

        .mode-btn {
            padding: 5px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            color: #666;
            background: transparent;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .config-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 6px;
            border: 1px solid #eee;
        }
        
        .config-label {
            font-weight: bold;
            color: #555;
            font-size: 0.9rem;
        }

        input[type="number"], input[type="text"] {
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        input[type="number"] { width: 50px; }
        input[type="text"] { width: 80px; text-align: center; }
        
        /* é–å®šè¼¸å…¥æ¡†æ¨£å¼ */
        input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
            color: #6c757d;
        }

        button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #1557b0; }
        
        .btn-success { background-color: #218838; color: white; }
        .btn-success:hover { background-color: #1e7e34; }
        
        .btn-warning { background-color: #ffc107; color: #333; }
        .btn-warning:hover { background-color: #e0a800; }

        .btn-info { background-color: #17a2b8; color: white; }
        .btn-info:hover { background-color: #138496; }
        
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        
        .btn-danger-outline {
            background-color: transparent;
            border: 1px solid #dc3545;
            color: #dc3545;
            font-size: 0.8rem;
            padding: 4px 8px;
        }
        .btn-danger-outline:hover {
            background-color: #dc3545;
            color: white;
        }

        .btn-outline { background-color: transparent; border: 1px solid var(--border-color); color: #666; }
        .btn-outline:hover { background-color: #f1f1f1; }

        /* ä¸»å·¥ä½œå€ */
        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* å·¦å´åº§ä½è¡¨ */
        #classroom-container {
            flex: 3;
            padding: 20px;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        #seating-grid {
            display: grid;
            gap: 15px; /* é è¨­æ•™å®¤æ¨¡å¼æœ‰é–“è· */
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            /* Grid columns å°‡ç”± JS å‹•æ…‹è¨­å®š */
        }

        /* å¯¦é©—å®¤æ¨¡å¼å°ˆç”¨ï¼šç·Šå¯†æ’åˆ— */
        #seating-grid.lab-mode {
            gap: 0px !important; /* å¼·åˆ¶ç„¡é–“éš™ */
            border: 1px solid #ccc; /* æ•´é«”å¤–æ¡† */
            padding: 0; /* ç§»é™¤å…§è·è®“æ ¼å­è²¼é‚Š */
        }

        /* åº§ä½å¡ç‰‡æ¨£å¼ä¿®æ­£ - å€åˆ†å§“åèˆ‡æŒ‰éˆ•å€ */
        .seat {
            width: 100px;
            height: 90px; /* ç¨å¾®åŠ é«˜ */
            border: 2px solid #ccc; /* é è¨­é‚Šæ¡†æ”¹æ·±ä¸€é» */
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* å…§å®¹å¾ä¸Šæ’åˆ°ä¸‹ */
            align-items: center;
            position: relative;
            background: #fdfdfd; /* æŒ‰éˆ•å€èƒŒæ™¯ */
            transition: transform 0.1s, border-color 0.2s;
            cursor: pointer;
            overflow: hidden; /* ç¢ºä¿åœ“è§’ */
        }
        
        /* å¯¦é©—å®¤æ¨¡å¼ä¸‹çš„åº§ä½æ¨£å¼èª¿æ•´ */
        .lab-mode .seat {
            border-radius: 0; /* ç§»é™¤åœ“è§’ */
            border: 1px solid #ccc; /* é‚Šæ¡†è®Šç´° */
            margin: 0; /* ç¢ºä¿ç„¡é‚Šè· */
            box-sizing: border-box; 
        }

        .seat:hover {
            transform: translateY(-2px);
            border-color: var(--primary-color);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 10; /* è®“ hover çš„æ ¼å­æµ®ä¸Šä¾† */
        }

        .seat.active-click {
            animation: pulse 0.3s ease-in-out;
            z-index: 11;
        }

        /* å§“åè¼¸å…¥å€ - åšæˆåç‰Œæ¨£å¼ */
        .seat input {
            width: 100%;
            padding: 5px 0;
            border: none;
            border-bottom: 1px solid #bbb;
            text-align: center;
            font-size: 1rem;
            background: #e9ecef; /* å§“åå€åº•è‰² (æ·ºç°) */
            color: #333;
            font-weight: bold;
            box-sizing: border-box;
        }

        .seat input:focus {
            outline: none;
            background: #dbeafe; /* èšç„¦æ™‚è®Šæ·ºè— */
            border-bottom-color: var(--primary-color);
        }

        /* é»æ“Šè§¸ç™¼å€æç¤º (é€™è£¡å…¶å¯¦æ˜¯å‰©ä¸‹çš„ div ç©ºé–“) */
        .seat::after {
            content: "é»æ“Šè¨˜éŒ„";
            font-size: 0.75rem;
            color: #aaa;
            margin-top: auto;
            margin-bottom: 5px;
            pointer-events: none; /* è®“é»æ“Šç©¿é€ */
        }

        .seat-badge {
            position: absolute;
            bottom: 5px; /* æ”¹åˆ°åº•éƒ¨ */
            right: 5px;
            background: #333;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 2;
        }

        /* å³å´æ§åˆ¶é¢æ¿ */
        aside {
            flex: 1;
            min-width: 320px;
            max-width: 360px;
            background-color: var(--panel-bg);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        /* è¡Œç‚ºé¸æ“‡é–‹é—œ */
        .behavior-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .behavior-btn {
            padding: 12px;
            border: 2px solid transparent;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: bold;
            text-align: center;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* è‡ªè¨‚è¼¸å…¥æ¡†æ¨£å¼ */
        .behavior-input-wrapper {
            grid-column: span 2; /* ä½”æ»¿å…©æ ¼ */
            display: flex;
            gap: 5px;
        }
        
        #custom-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            text-align: center;
            transition: all 0.2s;
            background: #fff;
        }
        
        #custom-input:focus {
            border-color: var(--c-custom);
            outline: none;
            background: #fff0f6;
        }
        
        #custom-input.active {
            border-color: var(--c-custom);
            background: #fff0f6;
            color: var(--c-custom);
            font-weight: bold;
        }

        /* è¡Œç‚ºæŒ‰éˆ•æ¨£å¼ */
        .b-serious { color: var(--c-serious); border-color: #e8f5e9; }
        .b-serious.selected { background: var(--c-serious); color: white; border-color: var(--c-serious); }
        
        .b-answer { color: var(--c-answer); border-color: #e3f2fd; }
        .b-answer.selected { background: var(--c-answer); color: white; border-color: var(--c-answer); }

        .b-sleep { color: var(--c-sleep); border-color: #f3e5f5; }
        .b-sleep.selected { background: var(--c-sleep); color: white; border-color: var(--c-sleep); }

        .b-chat { color: var(--c-chat); border-color: #fff3e0; }
        .b-chat.selected { background: var(--c-chat); color: white; border-color: var(--c-chat); }

        .b-phone { color: var(--c-phone); border-color: #f8d7da; }
        .b-phone.selected { background: var(--c-phone); color: white; border-color: var(--c-phone); }

        .b-distract { color: var(--c-distract); border-color: #e2e3e5; }
        .b-distract.selected { background: var(--c-distract); color: white; border-color: var(--c-distract); }
        
        /* æ–°å¢æ¨£å¼ */
        .b-change { color: var(--c-change); border-color: #e0f7fa; }
        .b-change.selected { background: var(--c-change); color: white; border-color: var(--c-change); }

        /* è¨˜éŒ„åˆ—è¡¨ */
        .log-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .log-item {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s ease-out;
        }

        .log-item:hover { background-color: #fff; }
        .log-time { color: #888; margin-right: 8px; font-size: 0.8rem; }
        .log-info { font-weight: 500; }
        .log-tag { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; color: white; margin-left: 5px; }
        .del-btn { color: #ccc; cursor: pointer; padding: 0 5px; }
        .del-btn:hover { color: #dc3545; }
        
        /* æ¨™é¡Œèˆ‡æ¸…é™¤æŒ‰éˆ•æ’ç‰ˆ */
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .log-header h3 {
            margin: 0;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0,0,0,0.2); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(0,0,0,0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0,0,0,0); }
        }

        .podium-marker {
            width: 100%;
            text-align: center;
            margin-top: 15px; /* èª¿æ•´é–“è· */
            background: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            color: #495057;
            font-weight: bold;
            letter-spacing: 2px;
            border: 2px solid #ced4da; /* å¢åŠ é‚Šæ¡†è®“è¬›å°æ›´æ˜é¡¯ */
        }
        
        /* Modal æ¨£å¼ (ç”¨æ–¼é›²ç«¯è¨­å®š) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 8px; width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .modal-footer {
            margin-top: 20px; text-align: right;
        }
    </style>
</head>
<body>

<header>
    <!-- ç¬¬ä¸€æ’ï¼šåŸºæœ¬è¨­å®šèˆ‡æ¨™é¡Œ -->
    <div class="header-row">
        <div class="title-group">
            <h1 class="main-title">ä¸Šèª²è§€æ¸¬è¨˜éŒ„</h1>
            
            <!-- æ¨¡å¼åˆ‡æ› -->
            <div class="mode-switch-group">
                <button id="mode-classroom" class="mode-btn active" onclick="switchMode('classroom')">æ•™å®¤åº§ä½</button>
                <button id="mode-lab" class="mode-btn" onclick="switchMode('lab')">å¯¦é©—å®¤</button>
            </div>
        </div>
        
        <div class="config-group">
            <span class="config-label">ç­ç´šä»£ç¢¼(3ç¢¼):</span>
            <input type="text" id="class-code" placeholder="å¦‚: 101" maxlength="3">
            <button class="btn-info" onclick="saveClassData()" title="å„²å­˜ç•¶å‰åº§ä½èˆ‡åå–®">å­˜æª”</button>
            <button class="btn-warning" onclick="loadClassData()" title="è®€å–è©²ä»£ç¢¼çš„åº§ä½è¡¨">è®€æª”</button>
        </div>
    </div>

    <!-- ç¬¬äºŒæ’ï¼šåº§ä½è¡¨ç”Ÿæˆèˆ‡åŒ¯å…¥èˆ‡å‚™ä»½ -->
    <div class="header-row">
        <div class="config-group">
            <!-- ä¿®æ­£ï¼šå°‡æ©«(åˆ—)çš„IDæ”¹ç‚ºrowsï¼Œç›´(æ’)çš„IDæ”¹ç‚ºcolsï¼Œä»¥ç¬¦åˆæ‚¨çš„å®šç¾© -->
            <span class="config-label">æ©«(åˆ—):</span>
            <input type="number" id="rows" value="5" min="1" max="15">
            <span class="config-label">ç›´(æ’):</span>
            <input type="number" id="cols" value="6" min="1" max="15">
            <button class="btn-primary" onclick="manualGenerate()" title="æ¸…ç©ºä¸¦ç”Ÿæˆæ–°çš„åº§ä½è¡¨">ç”Ÿæˆç©ºåº§ä½</button>
        </div>

        <div class="config-group">
            <input type="file" id="csv-upload" accept=".csv" style="display:none" onchange="processCSV(this)">
            <button class="btn-success" onclick="document.getElementById('csv-upload').click()">ğŸ“‚ åŒ¯å…¥CSV</button>
            
            <!-- æ–°å¢: ç³»çµ±å‚™ä»½èˆ‡é‚„åŸ -->
            <button class="btn-secondary" onclick="saveSystemConfig()" title="ä¸‹è¼‰ç›®å‰æ‰€æœ‰è¨­å®šç‚ºæª”æ¡ˆ">å‚™ä»½è¨­å®š(ä¸‹è¼‰)</button>
            <input type="file" id="config-upload" accept=".json" style="display:none" onchange="loadSystemConfig(this)">
            <button class="btn-secondary" onclick="document.getElementById('config-upload').click()" title="å¾æª”æ¡ˆé‚„åŸè¨­å®š">é‚„åŸè¨­å®š(ä¸Šå‚³)</button>
        </div>
    </div>
</header>

<main>
    <!-- å·¦å´åº§ä½å€ -->
    <div id="classroom-container">
        <div style="display: flex; flex-direction: column; align-items: center;">
            <div id="seating-grid">
                <!-- åº§ä½å°‡ç”± JS æ’å…¥ -->
            </div>
            <div class="podium-marker" id="podium">è¬›å° (TEACHER)</div>
        </div>
    </div>

    <!-- å³å´æ“ä½œå€ -->
    <aside>
        <h3>1. å­¸ç”Ÿä¸Šèª²æ¨¡å¼</h3>
        <div class="behavior-selector" id="behavior-group">
            <div class="behavior-btn b-serious selected" onclick="selectBehavior('èªçœŸ', this)">èªçœŸè½è¬›</div>
            <div class="behavior-btn b-answer" onclick="selectBehavior('æ¶ç­”', this)">ç©æ¥µæ¶ç­”</div>
            <div class="behavior-btn b-sleep" onclick="selectBehavior('ç¡è¦º', this)">ç¡è¦º</div>
            <div class="behavior-btn b-chat" onclick="selectBehavior('èŠå¤©', this)">èŠå¤©</div>
            <div class="behavior-btn b-phone" onclick="selectBehavior('æ»‘æ‰‹æ©Ÿ', this)">æ»‘æ‰‹æ©Ÿ</div>
            <div class="behavior-btn b-distract" onclick="selectBehavior('åˆ†å¿ƒ', this)">åˆ†å¿ƒ/ç™¼å‘†</div>
            <div class="behavior-btn b-change" onclick="selectBehavior('æ›åº§ä½', this)">æ›åº§ä½</div>
            
            <div class="behavior-input-wrapper">
                <input type="text" id="custom-input" placeholder="æ–°å¢(å¯ä»¥ç›´æ¥è¼¸å…¥)..." onfocus="handleCustomFocus(this)" oninput="handleCustomInput(this)">
            </div>
        </div>

        <div class="log-header">
            <h3>2. è§€æ¸¬è¨˜éŒ„</h3>
            <button class="btn-danger-outline" onclick="clearAllLogs()">åˆªé™¤æ‰€æœ‰è§€æ¸¬è¨˜éŒ„</button>
        </div>
        
        <div class="log-container" id="log-list"></div>

        <!-- åŒ¯å‡ºèˆ‡é›²ç«¯æŒ‰éˆ•å€ -->
        <div style="margin-top: auto; display: flex; flex-direction: column; gap: 5px;">
             <button class="btn-success" onclick="exportToExcel()">
                åŒ¯å‡ºè¨˜éŒ„ (.Excel / .xls)
            </button>
            <!-- é›²ç«¯è¨­å®šèˆ‡ä¸Šå‚³ -->
            <div style="display:flex; gap: 5px;">
                 <button class="btn-outline" style="flex:1" onclick="openCloudConfig()">âš™ï¸ Google Sheet è¨­å®š</button>
                 <button class="btn-primary" style="flex:2" onclick="uploadToGoogleSheet()">â˜ï¸ ä¸Šå‚³åˆ°é›²ç«¯</button>
            </div>
        </div>
    </aside>
</main>

<!-- é›²ç«¯è¨­å®š Modal -->
<div id="cloudModal" class="modal-overlay">
    <div class="modal-content">
        <h3>Google Apps Script è¨­å®š</h3>
        <p style="font-size: 0.9rem; color: #666;">
            è«‹è¼¸å…¥æ‚¨éƒ¨ç½²çš„ Google Apps Script ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ (ä»¥ https://script.google.com é–‹é ­)ï¼š
        </p>
        <textarea id="gas-url-input" rows="4" style="width: 100%; border: 1px solid #ccc; border-radius: 4px; padding: 5px;"></textarea>
        <div class="modal-footer">
            <button class="btn-outline" onclick="closeCloudConfig()">å–æ¶ˆ</button>
            <button class="btn-primary" onclick="saveCloudConfig()">å„²å­˜è¨­å®š</button>
        </div>
    </div>
</div>

<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    let currentBehavior = 'èªçœŸ';
    let isCustomMode = false;
    let logs = [];
    let currentMode = 'classroom'; 
    let gasUrl = ''; // Google Apps Script URL

    const colorMap = {
        'èªçœŸ': '#28a745', 'æ¶ç­”': '#007bff', 'ç¡è¦º': '#6f42c1',
        'èŠå¤©': '#fd7e14', 'æ»‘æ‰‹æ©Ÿ': '#dc3545', 'åˆ†å¿ƒ': '#6c757d',
        'æ›åº§ä½': '#17a2b8'
    };
    const CUSTOM_COLOR = '#d63384';

    window.onload = function() {
        loadFromStorage();
        // è®€å– GAS URL
        gasUrl = localStorage.getItem('gas_url') || '';
    };

    // --- ç³»çµ±å‚™ä»½èˆ‡é‚„åŸ (è§£æ±º GitHub Pages å­˜æª”æ¶ˆå¤±å•é¡Œ) ---
    function saveSystemConfig() {
        const backupData = {
            timestamp: new Date().toISOString(),
            localStorage: JSON.stringify(localStorage)
        };
        const blob = new Blob([JSON.stringify(backupData)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `åº§ä½è¡¨ç³»çµ±å‚™ä»½_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function loadSystemConfig(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.localStorage) {
                    if(confirm("ç¢ºå®šè¦é‚„åŸç³»çµ±è¨­å®šå—ï¼Ÿç›®å‰çš„è³‡æ–™å°‡è¢«è¦†è“‹ã€‚")) {
                        const storedData = JSON.parse(data.localStorage);
                        // æ¸…ç©ºä¸¦å¯«å…¥
                        localStorage.clear();
                        for (let key in storedData) {
                            localStorage.setItem(key, storedData[key]);
                        }
                        alert("é‚„åŸæˆåŠŸï¼é é¢å°‡é‡æ–°æ•´ç†ã€‚");
                        location.reload();
                    }
                } else {
                    alert("ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆæ ¼å¼ã€‚");
                }
            } catch(err) {
                alert("è®€å–æª”æ¡ˆå¤±æ•—ï¼š" + err);
            }
            input.value = ''; // Reset input
        };
        reader.readAsText(file);
    }

    // --- é›²ç«¯åŠŸèƒ½ ---
    function openCloudConfig() {
        document.getElementById('cloudModal').style.display = 'flex';
        document.getElementById('gas-url-input').value = gasUrl;
    }
    
    function closeCloudConfig() {
        document.getElementById('cloudModal').style.display = 'none';
    }
    
    function saveCloudConfig() {
        const url = document.getElementById('gas-url-input').value.trim();
        if(url) {
            gasUrl = url;
            localStorage.setItem('gas_url', gasUrl);
            alert("ç¶²å€å·²å„²å­˜ï¼");
            closeCloudConfig();
        } else {
            alert("è«‹è¼¸å…¥ç¶²å€");
        }
    }

    function uploadToGoogleSheet() {
        if (!gasUrl) {
            alert("è«‹å…ˆè¨­å®š Google Sheet (GAS) ç¶²å€ï¼");
            openCloudConfig();
            return;
        }
        
        if (logs.length === 0) {
            alert("ç›®å‰æ²’æœ‰ä»»ä½•è¨˜éŒ„å¯ä¸Šå‚³ã€‚");
            return;
        }
        
        // ä¿®æ”¹ï¼šå…ˆç¢ºèªç­ç´šä»£ç¢¼
        let classCode = document.getElementById('class-code').value.trim();
        if (!classCode) {
            classCode = prompt("æ‚¨å°šæœªè¼¸å…¥ç­ç´šä»£ç¢¼ï¼Œè«‹è¼¸å…¥ä»£ç¢¼ (ä¾‹å¦‚ 101) ä»¥ä¾¿åˆ†é¡åˆ†é ï¼š", "æœªåˆ†é¡ç­ç´š");
            // å¦‚æœä½¿ç”¨è€…æŒ‰å–æ¶ˆ
            if (!classCode) return;
            // å›å¡«åˆ°è¼¸å…¥æ¡†
            document.getElementById('class-code').value = classCode;
        }
        
        // ä¿®æ­£: ç§»é™¤ç¢ºèªè¦–çª—
        // if(!confirm(`å³å°‡å°‡è¨˜éŒ„ä¸Šå‚³è‡³ç­ç´šåˆ†é ï¼šã€${classCode}ã€‘ï¼Œç¢ºå®šå—ï¼Ÿ`)) return;
        
        const payload = {
            classCode: classCode,
            logs: logs
        };

        const btn = document.querySelector('button[onclick="uploadToGoogleSheet()"]');
        const originalText = btn.innerText;
        btn.innerText = "ä¸Šå‚³ä¸­...";
        btn.disabled = true;

        // ä½¿ç”¨ fetch ç™¼é€
        fetch(gasUrl, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: {
                 "Content-Type": "text/plain;charset=utf-8"
            }
        })
        .then(response => response.json())
        .then(data => {
            if(data.result === 'success') {
                alert(`ä¸Šå‚³æˆåŠŸï¼å…± ${data.count} ç­†è¨˜éŒ„å·²å¯«å…¥ Google Sheetã€‚`);
            } else {
                alert("ä¸Šå‚³å¤±æ•—ï¼š" + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("ä¸Šå‚³ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²å€æ˜¯å¦æ­£ç¢ºï¼Œæˆ– Google Script æ¬Šé™æ˜¯å¦è¨­ç‚ºã€Œæ‰€æœ‰äººã€ã€‚");
        })
        .finally(() => {
            btn.innerText = originalText;
            btn.disabled = false;
        });
    }

    // --- æ¨¡å¼åˆ‡æ›é‚è¼¯ ---
    function switchMode(mode) {
        if (currentMode === mode) return; 
        currentMode = mode;
        
        document.getElementById('mode-classroom').classList.remove('active');
        document.getElementById('mode-lab').classList.remove('active');
        document.getElementById(`mode-${mode}`).classList.add('active');
        
        const grid = document.getElementById('seating-grid');
        const podium = document.getElementById('podium');

        if (mode === 'lab') {
            grid.classList.add('lab-mode');
            podium.style.display = 'none'; 
        } else {
            grid.classList.remove('lab-mode');
            podium.style.display = 'block'; 
        }

        // æ³¨æ„ï¼šID å·²ç¶“äº¤æ›ï¼Œrows è¼¸å…¥æ¡†ç¾åœ¨å°æ‡‰ "æ©«(åˆ—)" (Vertical Count / Rows)
        const rowInput = document.getElementById('rows');
        const colInput = document.getElementById('cols');
        
        if (mode === 'lab') {
            rowInput.value = 5;
            colInput.value = 10;
            rowInput.disabled = true;
            colInput.disabled = true;
        } else {
            rowInput.disabled = false;
            colInput.disabled = false;
            const savedR = localStorage.getItem('pref_rows_classroom') || 5;
            const savedC = localStorage.getItem('pref_cols_classroom') || 6;
            rowInput.value = savedR;
            colInput.value = savedC;
        }
        loadFromStorage();
    }

    function getKey(prefix) {
        return `${prefix}_${currentMode}`;
    }

    function manualGenerate() {
        if(!confirm(`ç¢ºå®šè¦é‡æ–°ç”Ÿæˆã€${currentMode === 'classroom' ? 'æ•™å®¤' : 'å¯¦é©—å®¤'}ã€‘åº§ä½å—ï¼Ÿ\né€™å°‡æœƒã€Œæ¸…ç©ºã€ç›®å‰æ¨¡å¼åº§ä½ä¸Šçš„æ‰€æœ‰åå­—èˆ‡è¨˜éŒ„ï¼`)) return;
        
        if(currentMode === 'lab') {
            document.getElementById('rows').value = 5;
            document.getElementById('cols').value = 10;
        }

        const rows = document.getElementById('rows').value;
        const cols = document.getElementById('cols').value;
        
        localStorage.setItem(getKey('student_names'), '{}');
        localStorage.setItem(getKey('student_counts'), '{}');
        logs = []; 
        updateLogDisplay();
        
        generateSeats(rows, cols, false);
    }

    function generateSeats(rows, cols, keepData = true) {
        const grid = document.getElementById('seating-grid');
        
        if (currentMode === 'classroom') {
            localStorage.setItem(getKey('pref_rows'), rows);
            localStorage.setItem(getKey('pref_cols'), cols);
        }

        grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        grid.innerHTML = '';

        const savedNames = keepData ? JSON.parse(localStorage.getItem(getKey('student_names')) || '{}') : {};
        const savedCounts = keepData ? JSON.parse(localStorage.getItem(getKey('student_counts')) || '{}') : {};

        for (let r = 1; r <= rows; r++) {
            for (let c = 1; c <= cols; c++) {
                const seatId = `r${r}-c${c}`;
                const seatDiv = document.createElement('div');
                seatDiv.className = 'seat';
                seatDiv.id = `seat-${seatId}`;
                seatDiv.onclick = (e) => handleSeatClick(seatId, e);

                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = `${r}-${c}`;
                input.value = savedNames[seatId] || '';
                input.oninput = (e) => saveName(seatId, e.target.value);
                input.onclick = (e) => e.stopPropagation(); 

                const badge = document.createElement('badge');
                badge.className = 'seat-badge';
                badge.id = `badge-${seatId}`;
                if (savedCounts[seatId] && savedCounts[seatId] > 0) {
                    badge.innerText = savedCounts[seatId];
                    badge.style.opacity = 1;
                }

                seatDiv.appendChild(input);
                seatDiv.appendChild(badge);
                grid.appendChild(seatDiv);
            }
        }
    }

    function processCSV(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const lines = text.split(/\r\n|\n/);
            
            // æš«å­˜æ‰€æœ‰æ‰¾åˆ°çš„åå­— (æ‰å¹³åŒ–æ¸…å–®)
            let flatNameList = [];

            lines.forEach(line => {
                if(line.trim() === '') return;
                const cells = line.split(',');
                cells.forEach(cell => {
                    let name = cell.trim().replace(/^"|"$/g, '');
                    if (name && name !== '(X)' && name !== 'è¬›æ¡Œ') {
                        flatNameList.push(name);
                    }
                });
            });

            if (flatNameList.length === 0) { alert('æª”æ¡ˆå…§å®¹ç‚ºç©ºæˆ–ç„¡æœ‰æ•ˆå§“å'); return; }

            let maxRow = 0;
            let maxCol = 0;
            let newNames = {};

            if (currentMode === 'lab') {
                maxRow = 5;
                maxCol = 10;
                let listIndex = 0;
                for (let r = 1; r <= maxRow; r++) {
                    for (let c = 1; c <= maxCol; c++) {
                        if (listIndex < flatNameList.length) {
                            const seatId = `r${r}-c${c}`;
                            newNames[seatId] = flatNameList[listIndex];
                            listIndex++;
                        }
                    }
                }
                alert(`å·²å°‡ CSV ä¸­çš„ ${flatNameList.length} ç­†å§“åä¾åºå¡«å…¥å¯¦é©—å®¤åº§ä½è¡¨ (5x10)`);
            } else {
                // æ•™å®¤æ¨¡å¼ï¼šè‡ªå‹•åµæ¸¬ä¸¦ç§»é™¤ç©ºæ¬„
                
                // 1. å…ˆå°‡ CSV è§£ææˆäºŒç¶­é™£åˆ—
                let rawData = [];
                lines.forEach(line => {
                    if (line.trim() === '') return;
                    // ç°¡æ˜“ CSV åˆ‡å‰²ï¼Œç§»é™¤å¼•è™Ÿ
                    let cells = line.split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                    // å¦‚æœæ•´åˆ—éƒ½æ˜¯ç©ºçš„ï¼Œç•¥é
                    if (cells.every(c => c === '')) return;
                    rawData.push(cells);
                });

                if (rawData.length === 0) { alert('ç„¡æœ‰æ•ˆè³‡æ–™'); return; }

                // 2. æ‰¾å‡ºåŸå§‹æœ€å¤§å¯¬åº¦
                let rawMaxCol = 0;
                rawData.forEach(row => { if(row.length > rawMaxCol) rawMaxCol = row.length; });
                
                // 3. åµæ¸¬å“ªäº›æ¬„ä½æ˜¯ã€Œå…¨ç©ºã€çš„ (å¾ç¬¬0æ¬„åˆ°æœ€å¤§å¯¬åº¦)
                let emptyColIndices = new Set();
                for (let c = 0; c < rawMaxCol; c++) {
                    let isColEmpty = true;
                    for (let r = 0; r < rawData.length; r++) {
                        // åªè¦æœ‰ä¸€åˆ—åœ¨è©²æ¬„ä½æœ‰å€¼ï¼Œå°±ä¸æ˜¯å…¨ç©º
                        if (rawData[r][c] && rawData[r][c] !== '') {
                            isColEmpty = false;
                            break;
                        }
                    }
                    if (isColEmpty) emptyColIndices.add(c);
                }

                // 4. é‡å»ºç§»é™¤ç©ºæ¬„å¾Œçš„è³‡æ–™
                let compactData = [];
                rawData.forEach(row => {
                    let newRow = [];
                    for (let c = 0; c < row.length; c++) {
                        // åªä¿ç•™éç©ºæ¬„
                        if (!emptyColIndices.has(c)) {
                            newRow.push(row[c]);
                        }
                    }
                    compactData.push(newRow);
                });

                // 5. è¨­å®šæ–°çš„ Grid å¤§å°
                maxRow = compactData.length;
                maxCol = 0;
                compactData.forEach(row => { if(row.length > maxCol) maxCol = row.length; });
                
                // 6. å¡«å…¥è³‡æ–™
                compactData.forEach((row, rIndex) => {
                    row.forEach((cellText, cIndex) => {
                        let name = cellText; // å·²ç¶“è™•ç†é trim
                        if (name) {
                            const seatId = `r${rIndex+1}-c${cIndex+1}`;
                            newNames[seatId] = name;
                        }
                    });
                });
                
                document.getElementById('rows').value = maxRow;
                document.getElementById('cols').value = maxCol;
                
                // é¡¯ç¤ºæ›´æ¸…æ¥šçš„è¨Šæ¯
                const removedCount = emptyColIndices.size;
                let msg = `å·²åŒ¯å…¥æ•™å®¤åº§ä½è¡¨: ${maxRow} åˆ— x ${maxCol} æ’`;
                if (removedCount > 0) {
                    msg += ` (å·²è‡ªå‹•ç§»é™¤ ${removedCount} å€‹ç©ºç™½æ¬„ä½)`;
                }
                alert(msg);
            }

            localStorage.setItem(getKey('student_names'), JSON.stringify(newNames));
            if(confirm(`åŒ¯å…¥æˆåŠŸï¼æ˜¯å¦è¦åŒæ™‚æ¸…é™¤ã€${currentMode === 'classroom' ? 'æ•™å®¤' : 'å¯¦é©—å®¤'}ã€‘æ¨¡å¼çš„èˆŠä¸Šèª²è¨ˆæ•¸ï¼Ÿ(å»ºè­°é¸ç¢ºå®š)`)) {
                localStorage.setItem(getKey('student_counts'), '{}');
            }
            generateSeats(maxRow, maxCol, true);
            inputElement.value = '';
        };
        reader.readAsText(file, 'UTF-8');
    }

    function saveClassData() {
        const code = document.getElementById('class-code').value.trim();
        if (!code || code.length !== 3 || isNaN(code)) {
            alert('è«‹è¼¸å…¥ 3 ä½æ•¸å­—çš„ç­ç´šä»£ç¢¼ (ä¾‹å¦‚: 101, 205)');
            return;
        }

        const dataToSave = {
            rows: document.getElementById('rows').value,
            cols: document.getElementById('cols').value,
            names: JSON.parse(localStorage.getItem(getKey('student_names')) || '{}')
        };

        const key = `class_setup_${code}_${currentMode}`;
        localStorage.setItem(key, JSON.stringify(dataToSave));
        alert(`å·²å„²å­˜ç­ç´š [${code}] çš„ã€${currentMode === 'classroom' ? 'æ•™å®¤' : 'å¯¦é©—å®¤'}ã€‘åº§ä½è¡¨ï¼`);
    }

    function loadClassData() {
        const code = document.getElementById('class-code').value.trim();
        if (!code) { alert('è«‹è¼¸å…¥ç­ç´šä»£ç¢¼'); return; }

        const key = `class_setup_${code}_${currentMode}`;
        const savedDataStr = localStorage.getItem(key);

        if (!savedDataStr) {
            alert(`æ‰¾ä¸åˆ°ä»£ç¢¼ [${code}] åœ¨ã€${currentMode === 'classroom' ? 'æ•™å®¤' : 'å¯¦é©—å®¤'}ã€‘æ¨¡å¼çš„å­˜æª”ã€‚`);
            return;
        }

        if(confirm(`ç¢ºå®šè¦è®€å–ç­ç´š [${code}] çš„ã€${currentMode === 'classroom' ? 'æ•™å®¤' : 'å¯¦é©—å®¤'}ã€‘åº§ä½è¡¨å—ï¼Ÿ`)) {
            const data = JSON.parse(savedDataStr);
            document.getElementById('rows').value = data.rows;
            document.getElementById('cols').value = data.cols;
            localStorage.setItem(getKey('student_names'), JSON.stringify(data.names));
            localStorage.setItem(getKey('student_counts'), '{}');
            logs = [];
            updateLogDisplay();
            generateSeats(data.rows, data.cols, true);
        }
    }

    function selectBehavior(behavior, btnElement) {
        isCustomMode = false;
        currentBehavior = behavior;
        document.querySelectorAll('.behavior-btn').forEach(btn => btn.classList.remove('selected'));
        document.getElementById('custom-input').classList.remove('active');
        btnElement.classList.add('selected');
    }

    function handleCustomFocus(input) {
        isCustomMode = true;
        document.querySelectorAll('.behavior-btn').forEach(btn => btn.classList.remove('selected'));
        input.classList.add('active');
        if(input.value.trim()) {
            currentBehavior = input.value.trim();
        } else {
            currentBehavior = "è‡ªè¨‚è¨˜éŒ„";
        }
    }

    function handleCustomInput(input) {
        if(isCustomMode) {
            const val = input.value.trim();
            currentBehavior = val ? val : "è‡ªè¨‚è¨˜éŒ„";
        }
    }

    function handleSeatClick(seatId, event) {
        const input = document.querySelector(`#seat-${seatId} input`);
        const name = input.value.trim();

        if (!name) {
            alert("è©²åº§ä½ç„¡äººæˆ–æœªè¼¸å…¥å§“å");
            input.focus();
            return;
        }

        const seatDiv = document.getElementById(`seat-${seatId}`);
        const behaviorColor = colorMap[currentBehavior] || CUSTOM_COLOR;
        
        seatDiv.style.borderColor = behaviorColor;
        seatDiv.style.backgroundColor = behaviorColor + '11'; 
        seatDiv.classList.add('active-click');
        setTimeout(() => {
            seatDiv.style.borderColor = '';
            seatDiv.style.backgroundColor = '#fdfdfd';
            seatDiv.classList.remove('active-click');
        }, 300);

        const timestamp = new Date();
        const timeString = timestamp.toLocaleTimeString('zh-TW', { hour12: false });
        
        const logEntry = {
            id: Date.now(),
            seatId: seatId,
            name: name,
            behavior: currentBehavior,
            time: timeString,
            fullTime: timestamp.toISOString()
        };

        logs.push(logEntry);
        updateLogDisplay();
        updateSeatCount(seatId, 1);
        saveLogsToStorage();
    }

    function updateLogDisplay() {
        const list = document.getElementById('log-list');
        list.innerHTML = '';
        [...logs].reverse().forEach(log => {
            const item = document.createElement('div');
            item.className = 'log-item';
            const color = colorMap[log.behavior] || CUSTOM_COLOR;
            item.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <span class="log-time">[${log.time}]</span>
                    <span class="log-info">${log.name}</span>
                    <span class="log-tag" style="background-color: ${color}">${log.behavior}</span>
                </div>
                <div class="del-btn" onclick="deleteLog(${log.id}, '${log.seatId}')" title="åˆªé™¤">âœ•</div>
            `;
            list.appendChild(item);
        });
    }

    function deleteLog(logId, seatId) {
        logs = logs.filter(log => log.id !== logId);
        updateSeatCount(seatId, -1);
        updateLogDisplay();
        saveLogsToStorage();
    }
    
    function clearAllLogs() {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤ã€Œæ‰€æœ‰ã€è§€æ¸¬è¨˜éŒ„å—ï¼Ÿ\né€™å°‡æœƒæŠŠæ‰€æœ‰å­¸ç”Ÿçš„è¡Œç‚ºè¨ˆæ•¸æ­¸é›¶ï¼")) return;
        logs = [];
        updateLogDisplay();
        localStorage.setItem(getKey('student_counts'), '{}');
        const badges = document.querySelectorAll('.seat-badge');
        badges.forEach(badge => {
            badge.style.opacity = 0;
            badge.innerText = '';
        });
        saveLogsToStorage();
    }

    function updateSeatCount(seatId, delta) {
        let counts = JSON.parse(localStorage.getItem(getKey('student_counts')) || '{}');
        let current = counts[seatId] || 0;
        current += delta;
        if (current < 0) current = 0;
        counts[seatId] = current;
        localStorage.setItem(getKey('student_counts'), JSON.stringify(counts));

        const badge = document.getElementById(`badge-${seatId}`);
        if (current > 0) {
            badge.innerText = current;
            badge.style.opacity = 1;
        } else {
            badge.style.opacity = 0;
        }
    }

    function saveName(seatId, name) {
        let names = JSON.parse(localStorage.getItem(getKey('student_names')) || '{}');
        names[seatId] = name;
        localStorage.setItem(getKey('student_names'), JSON.stringify(names));
    }

    function saveLogsToStorage() {
        localStorage.setItem('class_logs', JSON.stringify(logs));
    }

    function loadFromStorage() {
        const savedLogs = localStorage.getItem('class_logs');
        if (savedLogs) {
            logs = JSON.parse(savedLogs);
            updateLogDisplay();
        }
        
        if (currentMode === 'lab') {
            document.getElementById('rows').value = 5;
            document.getElementById('cols').value = 10;
            document.getElementById('rows').disabled = true;
            document.getElementById('cols').disabled = true;
            const grid = document.getElementById('seating-grid');
            grid.classList.add('lab-mode');
            document.getElementById('podium').style.display = 'none';
            generateSeats(5, 10, true);
        } else {
            const r = localStorage.getItem('pref_rows_classroom') || 5;
            const c = localStorage.getItem('pref_cols_classroom') || 6;
            document.getElementById('rows').value = r;
            document.getElementById('cols').value = c;
            document.getElementById('rows').disabled = false;
            document.getElementById('cols').disabled = false;
            const grid = document.getElementById('seating-grid');
            grid.classList.remove('lab-mode');
            document.getElementById('podium').style.display = 'block';
            generateSeats(r, c, true);
        }
    }

    function exportToExcel() {
        if (logs.length === 0) {
            alert("ç„¡è¨˜éŒ„å¯åŒ¯å‡º");
            return;
        }
        
        let classCode = document.getElementById('class-code').value.trim();
        if(!classCode) classCode = "æœªå‘½åç­ç´š";

        let tableHTML = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" 
                  xmlns:x="urn:schemas-microsoft-com:office:excel" 
                  xmlns="http://www.w3.org/TR/REC-html40">
            <head>
                <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
                <!--[if gte mso 9]>
                <xml>
                <x:ExcelWorkbook>
                <x:ExcelWorksheets>
                <x:ExcelWorksheet>
                <x:Name>ä¸Šèª²è¨˜éŒ„</x:Name>
                <x:WorksheetOptions>
                <x:DisplayGridlines/>
                </x:WorksheetOptions>
                </x:ExcelWorksheet>
                </x:ExcelWorksheets>
                </x:ExcelWorkbook>
                </xml>
                <![endif]-->
                <style>
                    table { border-collapse: collapse; }
                    td, th { 
                        border: 1px solid black; 
                        font-size: 12pt; 
                        text-align: center; 
                        vertical-align: middle;
                        height: 35px;
                    }
                </style>
            </head>
            <body>
                <table>
                    <col width="100">
                    <col width="250">
                    <col width="150">
                    <col width="200">
                    <tr>
                        <th style="background-color: #f0f0f0;">åºè™Ÿ</th>
                        <th style="background-color: #f0f0f0;">ç™¼ç”Ÿæ™‚é–“</th>
                        <th style="background-color: #f0f0f0;">å§“å</th>
                        <th style="background-color: #f0f0f0;">è¡Œç‚ºé¡åˆ¥</th>
                    </tr>
        `;

        logs.forEach((log, index) => {
            const cleanName = log.name.replace(/,/g, ''); 
            tableHTML += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${log.fullTime}</td>
                    <td>${cleanName}</td>
                    <td>${log.behavior}</td>
                </tr>
            `;
        });

        tableHTML += `</table></body></html>`;

        const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        const dateStr = new Date().toISOString().slice(0,10);
        link.download = `${classCode}_${dateStr}_ä¸Šèª²è¨˜éŒ„.xls`; 
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>