<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>圓孔繞射（Airy Disk）物理模擬</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
    background-color: #0f172a;
    color: #f1f5f9;
}
.slider-label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}
canvas {
    image-rendering: pixelated;
}
</style>
</head>

<body class="flex flex-col items-center justify-center min-h-screen p-4">

<div class="max-w-4xl w-full bg-slate-800 p-6 rounded-2xl shadow-2xl border border-slate-700">

<h1 class="text-2xl font-bold mb-6 text-center bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">
圓孔繞射（Airy Disk）物理模擬
</h1>

<div class="relative flex flex-col items-center">

<div class="relative w-full aspect-square max-w-[500px] bg-black rounded-lg overflow-hidden border border-slate-600 shadow-inner">
<canvas id="diffractionCanvas" class="w-full h-full"></canvas>

<div class="absolute top-4 left-4 p-2 bg-slate-900/80 rounded border border-white/20">
<p class="text-[10px] mb-1 text-slate-400">孔徑示意（縮放）</p>
<canvas id="apertureCanvas" width="80" height="80"></canvas>
</div>

<div class="absolute bottom-4 right-4 text-right text-xs text-white/50">
<p id="infoDisplay"></p>
</div>
</div>

<div class="w-full mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">

<div>
<div class="slider-label">
<span>波長 λ</span>
<span id="waveValue" class="font-mono text-blue-400">550 nm</span>
</div>
<input type="range" id="wavelength" min="400" max="700" value="550">
</div>

<div>
<div class="slider-label">
<span>孔徑直徑 d</span>
<span id="apertureValue" class="font-mono text-emerald-400">0.10 mm</span>
</div>
<input type="range" id="aperture" min="0.05" max="0.30" value="0.10" step="0.01">
</div>

</div>
</div>

<div class="mt-8 p-4 bg-slate-900/50 rounded-lg border border-slate-700 text-sm text-slate-400 leading-relaxed">
<strong class="text-slate-300">物理說明：</strong>
相干光通過圓孔後，在遠場形成
<span class="italic text-blue-300">Airy Disk</span> 繞射圖樣。
第一暗環位置由
<span class="font-mono">1.22 λL / d</span> 決定。
<br>
<span class="text-slate-500">
※ 為了讓暗環清楚可見，顯示時對亮度做了非線性（Gamma）視覺增強，非實際能量比例。
</span>
</div>

</div>

<script>
const diffCanvas = document.getElementById("diffractionCanvas");
const aperCanvas = document.getElementById("apertureCanvas");
const diffCtx = diffCanvas.getContext("2d", { alpha: false });
const aperCtx = aperCanvas.getContext("2d");

const waveSlider = document.getElementById("wavelength");
const aperSlider = document.getElementById("aperture");
const waveValue = document.getElementById("waveValue");
const aperValue = document.getElementById("apertureValue");
const infoDisplay = document.getElementById("infoDisplay");

const L = 2.0;
const PI = Math.PI;

// 正確的一階第一類貝索函數 J1(x)
function besselJ1(x) {
    if (x === 0) return 0.0;
    let ax = Math.abs(x);
    if (ax < 8.0) {
        let y = x * x;
        let ans1 = x * (72362614232.0 + y * (-7895059235.0 +
            y * (242396853.1 + y * (-2972611.439 +
            y * (15704.48260 + y * (-30.16036606))))));
        let ans2 = 144725228464.0 + y * (376055370.0 +
            y * (96157.065 + y));
        return ans1 / ans2;
    } else {
        let z = 8.0 / ax;
        let y = z * z;
        let am = ax - 2.356194491;
        let ans1 = 1.0 + y * (0.183105e-2 +
            y * (-0.3516396496e-4 +
            y * (0.2457520174e-5)));
        let ans2 = 0.04687499995 +
            y * (-0.2002690873e-3 +
            y * (0.8449199096e-5));
        return Math.sqrt(0.636619772 / ax) *
            (Math.cos(am) * ans1 - z * Math.sin(am) * ans2);
    }
}

function wavelengthToRGB(w) {
    let r = 0, g = 0, b = 0;
    if (w < 440) { r = -(w - 440) / 60; b = 1; }
    else if (w < 490) { g = (w - 440) / 50; b = 1; }
    else if (w < 510) { g = 1; b = -(w - 510) / 20; }
    else if (w < 580) { r = (w - 510) / 70; g = 1; }
    else if (w < 645) { r = 1; g = -(w - 645) / 65; }
    else { r = 1; }
    return [r * 255, g * 255, b * 255];
}

function draw() {
    const lambda = waveSlider.value * 1e-9;
    const d = aperSlider.value * 1e-3;
    const color = wavelengthToRGB(waveSlider.value);

    waveValue.innerText = `${waveSlider.value} nm`;
    aperValue.innerText = `${aperSlider.value} mm`;
    infoDisplay.innerText = `L=${L} m , d=${aperSlider.value} mm`;

    aperCtx.clearRect(0, 0, 80, 80);
    aperCtx.beginPath();
    aperCtx.arc(40, 40, (d / 0.3e-3) * 35, 0, PI * 2);
    aperCtx.fillStyle = `rgb(${color[0]},${color[1]},${color[2]})`;
    aperCtx.fill();

    const w = diffCanvas.width;
    const h = diffCanvas.height;
    const img = diffCtx.createImageData(w, h);
    const data = img.data;

    const scale = 0.05 / w;

    for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
            const r = Math.hypot(
                (x - w / 2) * scale,
                (y - h / 2) * scale
            );

            const k = PI * d * r / (lambda * L);

            let I;
            if (k === 0) {
                I = 1.0;
            } else {
                I = Math.pow((2 * besselJ1(k)) / k, 2);
            }

            const v = Math.pow(I, 0.45);
            const i = (y * w + x) * 4;
            data[i] = color[0] * v;
            data[i + 1] = color[1] * v;
            data[i + 2] = color[2] * v;
            data[i + 3] = 255;
        }
    }
    diffCtx.putImageData(img, 0, 0);
}

function resize() {
    const s = Math.min(window.innerWidth, 500);
    diffCanvas.width = s;
    diffCanvas.height = s;
    draw();
}

window.addEventListener("resize", resize);
waveSlider.addEventListener("input", draw);
aperSlider.addEventListener("input", draw);
resize();
</script>

</body>
</html>
